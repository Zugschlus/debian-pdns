#! /bin/sh /usr/share/dpatch/dpatch-run
## cve-2008-3337.dpatch by Christoph Haas <haas@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Derived from http://wiki.powerdns.com/cgi-bin/trac.fcgi/changeset/1239

@DPATCH@
diff -urNad pdns~/pdns/packethandler.cc pdns/pdns/packethandler.cc
--- pdns~/pdns/packethandler.cc        2008-08-08 16:00:23.000000000 +0200
+++ pdns/pdns/packethandler.cc 2008-08-08 16:34:18.000000000 +0200
@@ -575,9 +575,11 @@
     // XXX FIXME do this in DNSPacket::parse ?

     if(!validDNSName(p->qdomain)) {
-      L<<Logger::Error<<"Received a malformed qdomain from "<<p->getRemote()<<", '"<<p->qdomain<<"': dropping"<<endl;
+      L<<Logger::Error<<"Received a malformed qdomain from "<<p->getRemote()<<", '"<<p->qdomain<<"': sending servfail"<<endl;
       S.inc("corrupt-packets");
-      return 0;
+      r=p->replyPacket();
+      r->setRcode(RCode::ServFail);
+      return r;
     }
     if(p->d.opcode) { // non-zero opcode (again thanks RA!)
       if(p->d.opcode==Opcode::Update) {
